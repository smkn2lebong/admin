<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>URC JKN - Admin Panel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f5f7fa; font-family:'Segoe UI',sans-serif; }
.card{ border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:1rem; }
</style>
</head>
<body>
<div class="container py-4">
<h3 class="mb-4">Dashboard Admin URC JKN</h3>
<a href="https://docs.google.com/spreadsheets/d/1-ztUi5Euy2hM5ZnndA_H5KAl-cvpW74VE2zVn62dU9U/edit?usp=sharing" target="_blank" class="btn btn-primary mb-3">Lihat Spreadsheet</a>
<div id="adminList" class="row gy-3"></div>
</div>

<div class="modal fade" id="alasanModal" tabindex="-1">
<div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Isi Alasan Penolakan</h5></div>
<div class="modal-body"><textarea id="alasanInput" class="form-control" rows="3"></textarea></div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
<button type="button" class="btn btn-danger" id="btnSaveAlasan">Simpan</button>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwXGyKAt0ptmxGM2XQYSNGnQZ81YJlTO3G7Biyj3qV1hrrUOOHgt8HMIY-OuJQtQ9uZ/exec";
let submissions=[], currentRejectId=null;

function fetchData(){
  fetch(WEB_APP_URL).then(res=>res.json()).then(data=>{
    submissions = data.map(d=>({...d,id:d["No NIK"]}));
    render();
  }).catch(err=>{
    console.error(err);
    document.getElementById('adminList').innerHTML='<div class="card p-3 text-danger">Gagal load data</div>';
  });
}

function render(){
  const adminList=document.getElementById('adminList');
  if(!submissions.length){ adminList.innerHTML='<div class="card p-3">Belum ada ajuan.</div>'; return; }
  adminList.innerHTML=submissions.slice().reverse().map(d=>`
  <div class="col-12 col-md-6">
  <div class="card p-3">
    <h5>${d["Nama"]}</h5>
    <p>NIK: ${d["No NIK"]} • KK: ${d["No KK"]} • HP: ${d["No HP"]}</p>
    <p>Alamat: ${d["Alamat"]}</p>
    <p>Puskesmas: ${d["Puskesmas"]}</p>
    <p>Relawan: ${d["Relawan"]} • Tgl Masuk: ${d["Tanggal Masuk"]}</p>
    <p>Surat Tidak Mampu: ${d["Surat Tidak Mampu"]} • Surat Rawat Inap: ${d["Surat Rawat Inap"]}</p>
    <p><a href="${d["Link Google Drive"]}" target="_blank">Link Drive</a></p>
    <p>Status: <span class="badge bg-${d.Status=='pending'?'secondary':d.Status=='proses'?'success':'danger'}">${d.Status}</span></p>
    ${d.Alasan?`<p>Alasan: ${d.Alasan}</p>`:''}
    <div class="d-flex gap-2">
      ${d.Status=="pending"?`<button class="btn btn-sm btn-success" onclick="updateStatus('${d.id}','proses')">Proses</button>
      <button class="btn btn-sm btn-danger" onclick="rejectStatus('${d.id}')">Tolak</button>`:''}
      <button class="btn btn-sm btn-outline-primary" onclick="copyData('${d.id}')">Copy Data</button>
    </div>
  </div></div>`).join('');
}

function updateStatus(id,status,alasan=''){
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"update",nik:id,status,alasan})})
  .then(res=>res.text()).then(fetchData).catch(console.error);
}

function rejectStatus(id){ currentRejectId=id; new bootstrap.Modal(document.getElementById('alasanModal')).show(); }
document.getElementById('btnSaveAlasan').addEventListener('click',()=>{
  const alasan=document.getElementById('alasanInput').value.trim()||'Tanpa alasan';
  updateStatus(currentRejectId,'ditolak',alasan);
  bootstrap.Modal.getInstance(document.getElementById('alasanModal')).hide();
  document.getElementById('alasanInput').value='';
});

function copyData(id){
  const d=submissions.find(x=>x.id==id);
  if(!d) return;
  navigator.clipboard.writeText(`Nama:${d.Nama}\nNIK:${d["No NIK"]}\nKK:${d["No KK"]}\nHP:${d["No HP"]}`).then(()=>alert('Data disalin!'));
}

// Fetch data setiap 10 detik untuk real-time
fetchData();
setInterval(fetchData,10000);
</script>
</body>
</html>
